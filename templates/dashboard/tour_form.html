{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ action }} Tour - TravelEase{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100">
    <div class="py-10">
        <header>
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h1 class="text-3xl font-bold leading-tight text-gray-900">{{ action }} Tour</h1>
            </div>
        </header>
        <main>
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <div class="mt-8">
                    <div class="bg-white shadow sm:rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <form method="POST" enctype="multipart/form-data" class="space-y-6">
                                {% csrf_token %}
                                
                                {% if form.errors %}
                                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                                        <strong class="font-bold">Error!</strong>
                                        <span class="block sm:inline">Please correct the errors below.</span>
                                    </div>
                                {% endif %}
                                
                                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                                    <div>
                                        <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Tour Name</label>
                                        {{ form.name|add_class:"appearance-none rounded-lg relative block w-full px-4 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 text-base h-12" }}
                                        {% if form.name.errors %}
                                            <p class="mt-2 text-sm text-red-600">{{ form.name.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div>
                                        <label for="{{ form.destination.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Destination</label>
                                        {{ form.destination|add_class:"appearance-none rounded-lg relative block w-full px-4 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 text-base h-12" }}
                                        {% if form.destination.errors %}
                                            <p class="mt-2 text-sm text-red-600">{{ form.destination.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="sm:col-span-2">
                                        <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                        {{ form.description|add_class:"appearance-none rounded-lg relative block w-full px-4 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 text-base" }}
                                        {% if form.description.errors %}
                                            <p class="mt-2 text-sm text-red-600">{{ form.description.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div>
                                        <label for="{{ form.duration_days.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Duration (Days)</label>
                                        {{ form.duration_days|add_class:"appearance-none rounded-lg relative block w-full px-4 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 text-base h-12" }}
                                        {% if form.duration_days.errors %}
                                            <p class="mt-2 text-sm text-red-600">{{ form.duration_days.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div>
                                        <label for="{{ form.price.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Price</label>
                                        {{ form.price|add_class:"appearance-none rounded-lg relative block w-full px-4 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 text-base h-12" }}
                                        {% if form.price.errors %}
                                            <p class="mt-2 text-sm text-red-600">{{ form.price.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div>
                                        <label for="{{ form.tour_type.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Tour Type</label>
                                        {{ form.tour_type|add_class:"appearance-none rounded-lg relative block w-full px-4 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 text-base h-12" }}
                                        {% if form.tour_type.errors %}
                                            <p class="mt-2 text-sm text-red-600">{{ form.tour_type.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div>
                                        <label for="{{ form.max_participants.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Maximum Participants</label>
                                        {{ form.max_participants|add_class:"appearance-none rounded-lg relative block w-full px-4 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 text-base h-12" }}
                                        {% if form.max_participants.errors %}
                                            <p class="mt-2 text-sm text-red-600">{{ form.max_participants.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div>
                                        <label for="{{ form.start_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                                        {{ form.start_date|add_class:"appearance-none rounded-lg relative block w-full px-4 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 text-base h-12" }}
                                        {% if form.start_date.errors %}
                                            <p class="mt-2 text-sm text-red-600">{{ form.start_date.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div>
                                        <label for="{{ form.end_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                                        {{ form.end_date|add_class:"appearance-none rounded-lg relative block w-full px-4 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 text-base h-12" }}
                                        {% if form.end_date.errors %}
                                            <p class="mt-2 text-sm text-red-600">{{ form.end_date.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="sm:col-span-2">
                                        <label for="{{ form.included_services.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Included Services</label>
                                        {{ form.included_services|add_class:"appearance-none rounded-lg relative block w-full px-4 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 text-base" }}
                                        {% if form.included_services.errors %}
                                            <p class="mt-2 text-sm text-red-600">{{ form.included_services.errors.0 }}</p>
                                        {% endif %}
                                    </div>

                                    <div class="sm:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tour Images</label>
                                        {% if form.instance.id and form.instance.images.all %}
                                            <div class="grid grid-cols-3 gap-4 mt-2">
                                                {% for image in form.instance.images.all %}
                                                    <div class="relative" data-image-id="{{ image.id }}">
                                                        <img src="{{ image.image.url }}" alt="Tour Image" class="h-32 w-full object-cover rounded-lg">
                                                        <button type="button" 
                                                                onclick="deleteImage('{{ image.id }}')" 
                                                                class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="mt-2">
                                            {{ form.images|add_class:"hidden" }}
                                            <label for="{{ form.images.auto_id }}" class="cursor-pointer inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                                                <i class="fas fa-plus mr-2"></i> Add Images
                                            </label>
                                        </div>
                                        <div id="imagePreview" class="grid grid-cols-3 gap-4 mt-2"></div>
                                        {% if form.images.errors %}
                                            <p class="mt-2 text-sm text-red-600">{{ form.images.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-4 mt-6">
                                    <a href="{% url 'manage_tours' %}" class="inline-flex items-center px-6 py-3 border border-gray-300 shadow-sm text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                        Cancel
                                    </a>
                                    <button type="submit" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                                        {{ action }} Tour
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
// Store loader HTML in a variable
const loaderHTML = `
<div class="loader">
  <svg height="0" width="0" viewBox="0 0 64 64" class="absolute">
    <defs class="s-xJBuHA073rTt" xmlns="http://www.w3.org/2000/svg">
      <linearGradient class="s-xJBuHA073rTt" gradientUnits="userSpaceOnUse" y2="2" x2="0" y1="62" x1="0" id="b">
        <stop class="s-xJBuHA073rTt" stop-color="#973BED"></stop>
        <stop class="s-xJBuHA073rTt" stop-color="#007CFF" offset="1"></stop>
      </linearGradient>
      <linearGradient class="s-xJBuHA073rTt" gradientUnits="userSpaceOnUse" y2="0" x2="0" y1="64" x1="0" id="c">
        <stop class="s-xJBuHA073rTt" stop-color="#FFC800"></stop>
        <stop class="s-xJBuHA073rTt" stop-color="#F0F" offset="1"></stop>
        <animateTransform repeatCount="indefinite" keySplines=".42,0,.58,1;.42,0,.58,1;.42,0,.58,1;.42,0,.58,1;.42,0,.58,1;.42,0,.58,1;.42,0,.58,1;.42,0,.58,1" keyTimes="0; 0.125; 0.25; 0.375; 0.5; 0.625; 0.75; 0.875; 1" dur="8s" values="0 32 32;-270 32 32;-270 32 32;-540 32 32;-540 32 32;-810 32 32;-810 32 32;-1080 32 32;-1080 32 32" type="rotate" attributeName="gradientTransform"></animateTransform>
      </linearGradient>
      <linearGradient class="s-xJBuHA073rTt" gradientUnits="userSpaceOnUse" y2="2" x2="0" y1="62" x1="0" id="d">
        <stop class="s-xJBuHA073rTt" stop-color="#00E0ED"></stop>
        <stop class="s-xJBuHA073rTt" stop-color="#00DA72" offset="1"></stop>
      </linearGradient>
    </defs>
  </svg>
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 64 64" height="64" width="64" class="inline-block">
    <path stroke-linejoin="round" stroke-linecap="round" stroke-width="8" stroke="url(#b)" d="M 54.722656,3.9726563 A 2.0002,2.0002 0 0 0 54.941406,4 h 5.007813 C 58.955121,17.046124 49.099667,27.677057 36.121094,29.580078 a 2.0002,2.0002 0 0 0 -1.708985,1.978516 V 60 H 29.587891 V 31.558594 A 2.0002,2.0002 0 0 0 27.878906,29.580078 C 14.900333,27.677057 5.0448787,17.046124 4.0507812,4 H 9.28125 c 1.231666,11.63657 10.984383,20.554048 22.6875,20.734375 a 2.0002,2.0002 0 0 0 0.02344,0 c 11.806958,0.04283 21.70649,-9.003371 22.730469,-20.7617187 z" class="dash" id="y" pathLength="360"></path>
  </svg>
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" style="--rotation-duration:0ms; --rotation-direction:normal;" viewBox="0 0 64 64" height="64" width="64" class="inline-block">
    <path stroke-linejoin="round" stroke-linecap="round" stroke-width="10" stroke="url(#c)" d="M 32 32 m 0 -27 a 27 27 0 1 1 0 54 a 27 27 0 1 1 0 -54" class="spin" id="o" pathLength="360"></path>
  </svg>
  <div class="w-2"></div>
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" style="--rotation-duration:0ms; --rotation-direction:normal;" viewBox="0 0 64 64" height="64" width="64" class="inline-block">
    <path stroke-linejoin="round" stroke-linecap="round" stroke-width="8" stroke="url(#d)" d="M 4,4 h 4.6230469 v 25.919922 c -0.00276,11.916203 9.8364941,21.550422 21.7500001,21.296875 11.616666,-0.240651 21.014356,-9.63894 21.253906,-21.25586 a 2.0002,2.0002 0 0 0 0,-0.04102 V 4 H 56.25 v 25.919922 c 0,14.33873 -11.581192,25.919922 -25.919922,25.919922 a 2.0002,2.0002 0 0 0 -0.0293,0 C 15.812309,56.052941 3.998433,44.409961 4,29.919922 Z" class="dash" id="u" pathLength="360"></path>
  </svg>
</div>`;

function previewImages(input) {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    
    if (input.files) {
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const div = document.createElement('div');
                div.className = 'relative';
                div.innerHTML = `
                    <img src="${e.target.result}" class="h-32 w-full object-cover rounded-lg">
                    <button type="button" class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                preview.appendChild(div);
            }
            reader.readAsDataURL(file);
        });
    }
}

async function deleteImage(imageId) {
    if (!confirm('Are you sure you want to delete this image?')) {
        return;
    }
    
    const imageElement = document.querySelector(`[data-image-id="${imageId}"]`);
    if (imageElement) {
        // Show loader
        const loader = document.createElement('div');
        loader.innerHTML = loaderHTML;
        imageElement.appendChild(loader);
        
        try {
            const response = await fetch(`/api/tour-images/${imageId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            });
            
            if (response.ok) {
                imageElement.remove();
            } else {
                alert('Failed to delete image. Please try again.');
                // Remove loader on error
                loader.remove();
            }
        } catch (error) {
            console.error('Error deleting image:', error);
            alert('An error occurred while deleting the image.');
            // Remove loader on error
            loader.remove();
        }
    }
}

// Add form submission handler with loader
document.querySelector('form').addEventListener('submit', function(e) {
    const submitButton = this.querySelector('button[type="submit"]');
    const loader = document.createElement('div');
    loader.innerHTML = loaderHTML;
    loader.style.marginLeft = '1rem';
    submitButton.disabled = true;
    submitButton.parentNode.insertBefore(loader, submitButton.nextSibling);
});
</script>
{% endblock %}